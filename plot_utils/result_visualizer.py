"""
Script for restoring results array from .npz dump file generated by CNN training engine

Author: Julian Ding
"""

import os, sys
if os.getcwd() not in sys.path:
    sys.path.append(os.getcwd())
    
import argparse
import numpy as np
import plot_utils.plot_utils as plu

def parse_args():
    parser = argparse.ArgumentParser(
        description="Normalizes data from an input HDF5 file and outputs to HDF5 file.")
    parser.add_argument("--input_file", '-in', dest="input_file", type=str, nargs=1,
                        help="path to dataset to visualize", required=True)
    parser.add_argument('--output_path', '-out', dest="output_path", type=str, nargs=1,
                        help="desired output path", required=True)
    args = parser.parse_args()
    return args

# Returns a results dictionary
def open_result(path):
    assert os.path.isfile(path), "Provided file ("+path+") does not exist, aborting."
    return np.load(path)

# Dumps an instance of every plot in plot_utils to save_path based on data in result
def dump_visuals(result, save_path=''):
    save_path += '' if save_path.endswith('/') else '/'
    if not os.path.isdir(save_path):
        print("Making output directory as ", save_path)
        os.mkdir(save_path)
    
    prediction = result['prediction']
    softmax = result['softmax']
    loss = result['loss']
    accuracy = result['accuracy']
    labels = result['labels']
    energies = result['energies']

    vis_energies = plu.convert_to_visible_energy(energies, labels)
    
    class_names = ['gamma', 'e', 'mu']
    index_dict = {name:index for index, name in enumerate(class_names)}
    
    plu.plot_event_energy_distribution(vis_energies, labels, index_dict, save_path=save_path+"energy_distribution.eps")
    plu.plot_confusion_matrix(labels, prediction, vis_energies, class_names, 0, np.amax(vis_energies), save_path=save_path+"confusion_matrix.eps")
    
    for i, name in enumerate(class_names):
        plu.plot_classifier_response(softmax, labels, vis_energies, index_dict, {name:i}, save_path=save_path+"classifier_response_"+name+".eps")
        other = class_names[(i+1)%len(class_names)]
        plu.plot_ROC_curve_one_vs_one(softmax, labels, vis_energies, index_dict, name, other, 0, np.max(vis_energies), save_path=save_path+name+"_vs_"+other+".eps")
    index_dict = {name:index for index, name in enumerate(class_names[:2])}
    for name, i in index_dict.items():
        plu.plot_signal_efficiency(softmax, labels, vis_energies, index_dict, name, save_path=save_path+"signal_efficiency_"+name+".eps",
                                   num_bins=10)
        plu.plot_background_rejection(softmax, labels, vis_energies, index_dict, name, save_path=save_path+"background_rejection_"+name+".eps",
                                      num_bins=10)
    print ("Dumped performance plots to", save_path)
    
if __name__ == "__main__":
    config = parse_args()
    result = open_result(config.input_file[0])
    dump_visuals(result, config.output_path[0])